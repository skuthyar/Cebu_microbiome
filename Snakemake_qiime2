# Snakefile for QIIME 2 analysis

SAMPLES = "/FILE.csv"
CLASSIFIER = "/CLASSIFIER.qza"
METADATA = "/METADATA.txt"
OUTPUT_DIR = "/PATH"
NUM_THREADS = 8

rule all:
    input:
        f"{OUTPUT_DIR}/ASV-TABLE.txt",
        f"{OUTPUT_DIR}/taxonomy.txt",
        f"{OUTPUT_DIR}/unrooted_tree.nwk",
        f"{OUTPUT_DIR}/filtered_table.qza"

rule import_data:
    output:
        f"{OUTPUT_DIR}/FILE.qza"
    shell:
        "qiime tools import --type 'SampleData[PairedEndSequencesWithQuality]' "
        "--input-path {SAMPLES} --output-path {output} "
        "--input-format PairedEndFastqManifestPhred33"

rule summarize_demux:
    input:
        f"{OUTPUT_DIR}/FILE.qza"
    output:
        f"{OUTPUT_DIR}/FILE.qzv"
    shell:
        "qiime demux summarize --i-data {input} --o-visualization {output}"

rule dada2_denoise:
    input:
        f"{OUTPUT_DIR}/FILE.qza"
    output:
        table=f"{OUTPUT_DIR}/TABLE.qza",
        rep_seqs=f"{OUTPUT_DIR}/REPSEQS.qza",
        stats=f"{OUTPUT_DIR}/STATS.qza"
    shell:
        "qiime dada2 denoise-paired --i-demultiplexed-seqs {input} "
        "--p-trunc-len-f 250 --p-trunc-len-r 250 "
        "--p-trim-left-f 20 --p-trim-left-r 20 "
        "--p-max-ee-f 6 --p-max-ee-r 6 --p-n-threads {NUM_THREADS} "
        "--o-table {output.table} --o-representative-sequences {output.rep_seqs} "
        "--o-denoising-stats {output.stats}"

rule examine_results:
    input:
        f"{OUTPUT_DIR}/STATS.qza"
    output:
        f"{OUTPUT_DIR}/STATS.qzv"
    shell:
        "qiime metadata tabulate --m-input-file {input} --o-visualization {output}"

rule phylogeny:
    input:
        rep_seqs=f"{OUTPUT_DIR}/REPSEQS.qza"
    output:
        alignment=f"{OUTPUT_DIR}/ALIGNEDSEQS.qza",
        masked=f"{OUTPUT_DIR}/MASKEDSEQS.qza",
        unrooted=f"{OUTPUT_DIR}/UNROOTEDTREE.qza",
        rooted=f"{OUTPUT_DIR}/ROOTEDTREE.qza"
    shell:
        "qiime phylogeny align-to-tree-mafft-fasttree --i-sequences {input.rep_seqs} "
        "--o-alignment {output.alignment} --o-masked-alignment {output.masked} "
        "--o-tree {output.unrooted} --o-rooted-tree {output.rooted}"

rule classify_taxonomy:
    input:
        rep_seqs=f"{OUTPUT_DIR}/REPSEQS.qza"
    output:
        f"{OUTPUT_DIR}/TAXONOMY.qza"
    shell:
        "qiime feature-classifier classify-sklearn --i-classifier {CLASSIFIER} "
        "--i-reads {input.rep_seqs} --o-classification {output}"

rule filter_samples:
    input:
        table=f"{OUTPUT_DIR}/TABLE.qza",
        taxonomy=f"{OUTPUT_DIR}/TAXONOMY.qza"
    output:
        filtered=f"{OUTPUT_DIR}/FILTEREDTABLE.qza"
    shell:
        "qiime taxa filter-table --i-table {input.table} "
        "--i-taxonomy {input.taxonomy} --p-exclude mitochondria,chloroplast "
        "--o-filtered-table {output.filtered}"

rule filter_samples_by_metadata:
    input:
        filtered_table=f"{OUTPUT_DIR}/FILTEREDTABLE.qza"
    output:
        f"{OUTPUT_DIR}/FILTEREDTABLE2.qza"
    shell:
        "qiime feature-table filter-samples --i-table {input.filtered_table} "
        "--m-metadata-file {METADATA} --o-filtered-table {output}"

rule export_unrarefied_data:
    input:
        filtered_table=f"{OUTPUT_DIR}/FILTEREDTABLE2.qza"
    output:
        directory(OUTPUT_DIR)
    shell:
        "qiime tools export --input-path {input.filtered_table} --output-path {output}"

rule convert_biom:
    input:
        f"{OUTPUT_DIR}/FEATURE-TABLE.biom"
    output:
        f"{OUTPUT_DIR}/ASV-TABLE.txt"
    shell:
        "biom convert -i {input} -o {output} --to-tsv"

rule export_taxonomy:
    input:
        f"{OUTPUT_DIR}/TAXONOMY.qza"
    output:
        f"{OUTPUT_DIR}/taxonomy.txt"
    shell:
        "qiime tools export --input-path {input} --output-path {output}"

rule export_unrooted_tree:
    input:
        f"{OUTPUT_DIR}/UNROOTEDTREE.qza"
    output:
        f"{OUTPUT_DIR}/unrooted_tree.nwk"
    shell:
        "qiime tools export --input-path {input} --output-path {output}"
